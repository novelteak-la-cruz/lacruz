<!-- Header solo en modo completo -->
<app-header *ngIf="!compact"></app-header>

<!-- Modo compacto: solo el mapa -->
<div *ngIf="compact" class="compact-kml-viewer" style="width: 100%; height: 100%; position: relative;">
    <!-- Estado de carga -->
    <div *ngIf="isLoading" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">{{ translations.loading || 'Cargando...' }}</span>
            </div>
            <div class="loading-text mb-3">{{ loadingMessage }}</div>
        </div>
    </div>

    <!-- Error -->
    <div *ngIf="errorMessage" class="error-overlay">
        <div class="error-content">
            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
            <div class="error-text mt-2">{{ errorMessage }}</div>
            <div class="mt-2">
                <button class="btn btn-sm btn-primary me-2" (click)="forceInit()">
                    <i class="bi bi-arrow-clockwise"></i> {{ translations.retry || 'Reintentar' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Mapa compacto -->
    <div #mapContainer class="map-container" [style.opacity]="isLoading ? '0.3' : '1'" style="width: 100%; height: 100%;"></div>

    <!-- Botón Ver Mapa Completo - Parte inferior derecha -->
    <div class="position-absolute bottom-0 end-0 mb-3 me-3" style="z-index: 1000;">
        <button 
            class="btn btn-primary btn-sm shadow" 
            (click)="openFullMap()"
            [title]="translations.viewFullMap || 'Ver mapa completo'">
            <i class="fas fa-expand me-1"></i>
            <span class="d-none d-sm-inline">{{ translations.viewFullMap || 'Ver mapa completo' }}</span>
            <span class="d-sm-none">{{ translations.fullMap || 'Completo' }}</span>
        </button>
    </div>
</div>

<!-- Modo completo: con sidebar y header -->
<div *ngIf="!compact" class="kml-viewer-container">
    <div class="viewer-layout">
        <!-- Sidebar - 1/4 de la pantalla -->
        <div class="sidebar-section">
            <div class="info-panel">
                <div class="card rounded-0">
                    <div class="card-header bg-primary rounded-0">
                        <h6 class="m-0 text-white">
                            <i class="bi bi-layers-fill me-2"></i>
                            {{ translations.propertyInformation || 'Información de la Propiedad' }}
                        </h6>
                        <span class="badge bg-light text-white">{{ kmlData.length }}</span>
                    </div>
                    <div class="card-body">
                        <!-- Elementos del KML -->
                        <div class="elements-list">
                            <div *ngFor="let item of kmlData" class="element-item"
                                (click)="zoomToElement(item, $event)">
                                <div class="element-header">
                                    <div class="element-info">
                                        <div class="element-name">{{ getElementDisplayName(item) }}</div>
                                        <span class="element-badge" [class]="getTypeBadgeClass(item.type)">
                                            {{ getTypeLabel(item.type) }}
                                        </span>
                                    </div>
                                    <button class="zoom-btn" (click)="zoomToElement(item, $event)">
                                        <i class="fa-solid fa-magnifying-glass-plus"></i>
                                    </button>
                                </div>

                                <!-- Información detallada -->
                                <div class="element-details">
                                    <div *ngIf="item.extendedData?.HECTAREAS" class="detail-row">
                                        <span class="detail-label">{{ translations.areaLabel || 'Área' }}:</span>
                                        <span class="detail-value">{{ item.extendedData.HECTAREAS }} ha</span>
                                    </div>
                                    <div *ngIf="item.extendedData?.FOLIO" class="detail-row">
                                        <span class="detail-label">{{ translations.folio || 'Folio' }}:</span>
                                        <span class="detail-value">{{ item.extendedData.FOLIO }}</span>
                                    </div>
                                    <div *ngIf="item.extendedData?.PLANO" class="detail-row">
                                        <span class="detail-label">{{ translations.planLabel || 'Plano' }}:</span>
                                        <span class="detail-value">{{ item.extendedData.PLANO }}</span>
                                    </div>
                                    <div *ngIf="item.extendedData?.FINCA" class="detail-row">
                                        <span class="detail-label">{{ translations.farm || 'Finca' }}:</span>
                                        <span class="detail-value">{{ item.extendedData.FINCA }}</span>
                                    </div>
                                </div>
                            </div>

                            <div *ngIf="kmlData.length === 0 && !isLoading" class="empty-state">
                                <i class="bi bi-inbox" style="font-size: 2rem; color: #6c757d;"></i>
                                <div class="mt-2">
                                    <small class="text-muted">{{ translations.noPropertiesFound || 'No se encontraron propiedades' }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Resumen General -->
                        <div class="summary-section mt-3" *ngIf="kmlData.length > 0">
                            <div class="summary-header">
                                <h6 class="summary-title">
                                    <i class="bi bi-bar-chart-fill me-2"></i>
                                    {{ translations.generalSummary || 'Resumen General' }}
                                </h6>
                            </div>
                            <div class="summary-content">
                                <div class="summary-item">
                                    <div class="summary-label">{{ translations.totalArea || 'Área Total' }}:</div>
                                    <div class="summary-value">{{ getTotalArea() }} ha</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">{{ translations.averageArea || 'Área Promedio' }}:</div>
                                    <div class="summary-value">{{ getAverageArea() }} ha</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">{{ translations.propertiesWithFolio || 'Propiedades con Folio' }}:</div>
                                    <div class="summary-value">{{ getPropertiesWithFolio() }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área del mapa - 3/4 de la pantalla -->
        <div class="map-section">
            <!-- Estado de carga -->
            <div *ngIf="isLoading" class="loading-overlay">
                <div class="loading-content">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">{{ translations.loading || 'Cargando...' }}</span>
                    </div>
                    <div class="loading-text mb-3">{{ loadingMessage }}</div>
                    <!-- Botón manual si tarda mucho -->
                    <button class="btn btn-outline-primary" (click)="forceInit()">
                        <i class="bi bi-play-circle"></i> {{ translations.initializeManually || 'Inicializar Manualmente' }}
                    </button>
                </div>
            </div>

            <!-- Error -->
            <div *ngIf="errorMessage" class="error-overlay">
                <div class="error-content">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <div class="error-text mt-3">{{ errorMessage }}</div>
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" (click)="forceInit()">
                            <i class="bi bi-arrow-clockwise"></i> {{ translations.retry || 'Reintentar' }}
                        </button>
                        <button class="btn btn-info" (click)="debug()">
                            <i class="bi bi-bug"></i> {{ translations.debug || 'Debug' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mapa -->
            <div #mapContainer class="map-container" [style.opacity]="isLoading ? '0.3' : '1'"></div>
        </div>
    </div>
</div>